# 네이버 메일 통합 웹 서비스

Flask 기반의 네이버 메일 관리 웹 애플리케이션입니다. 메일 조회, 본문/첨부파일 요약, 첨부파일 다운로드, 회신 기능을 제공합니다.

## 주요 기능

### 1. 메일박스 선택 및 조회
- **메일박스 선택**:
  - 받은편지함 (INBOX)
  - 보낸편지함 (INBOX/Sent)
  - 휴지통 (INBOX/Trash)
  - 스팸함 (INBOX/Spam)
- **메일 필터링**:
  - 전체 메일: 선택한 메일박스의 모든 메일
  - 안읽은 메일: 읽지 않은 메일만
  - 읽은 메일: 읽은 메일만
- 조회 개수 설정 (1~100개)
- 메일 목록 실시간 조회

### 2. 메일 상세 보기
- 발신자, 수신자, 날짜 정보
- 본문 텍스트 표시
- 첨부파일 목록 및 추출된 텍스트 미리보기
- **첨부파일 다운로드**: 각 첨부파일을 로컬로 다운로드 가능

### 3. 메일 요약 (OpenAI API)
#### 본문 요약
- 메일 본문 내용을 선택적으로 요약
- 체크박스로 본문 요약 여부 선택

#### 첨부파일 요약
- PDF, Word, Excel, PowerPoint 파일 내용 자동 추출 및 요약
- 체크박스로 첨부파일 요약 여부 선택
- 각 첨부파일별 개별 요약 제공

#### 요약 타입 선택
- **간단**: 핵심만 간략하게 요약
- **상세**: 자세한 요약 제공
- **목록**: 불릿 포인트 형식
- **한국어**: 한국어 최적화 요약

#### LLM 모델 선택
- **GPT-4o Mini** (기본, 빠르고 경제적)
- **GPT-4o** (최신 모델)
- **GPT-4 Turbo** (향상된 성능)
- **GPT-4** (고성능)
- **GPT-3.5 Turbo** (빠른 응답)

#### 요약 통계
- 원본 토큰 수
- 요약 토큰 수
- 압축률 표시

### 4. 메일 회신
- 선택한 메일에 대한 회신 작성
- 원본 메일 자동 인용
- Re: 접두사 자동 추가
- 발신자 이메일 자동 입력
- SMTP를 통한 메일 전송

### 5. 첨부파일 관리 및 요약
- **자동 다운로드**: 메일 조회 시 첨부파일 자동 다운로드 및 저장
- **텍스트 추출**: PDF, Word, Excel, PPT 파일의 텍스트 자동 추출
- **다운로드 기능**: 웹 UI에서 첨부파일을 로컬로 다운로드
- **개별 첨부파일 요약**: 다운로드된 첨부파일을 선택하여 개별 요약 가능
  - 각 첨부파일마다 "요약" 버튼 제공
  - 선택한 LLM 모델과 요약 타입으로 요약
  - 요약 결과 및 통계 표시
- **지원 형식**:
  - PDF (.pdf)
  - Word (.docx, .doc)
  - Excel (.xlsx, .xls)
  - PowerPoint (.pptx, .ppt)
  - 텍스트 (.txt, .csv, .log, .md, .json, .xml, .html)

## 시스템 요구사항

- Python 3.8 이상
- 네이버 메일 계정
- OpenAI API 키 (요약 기능 사용 시)

## 설치 방법

### 1. 의존성 패키지 설치

```bash
pip install -r requirements.txt
```

### 2. 네이버 메일 앱 비밀번호 발급

1. 네이버 로그인 후 [https://nid.naver.com/user2/help/myInfo?lang=ko_KR](https://nid.naver.com/user2/help/myInfo?lang=ko_KR) 접속
2. 보안 설정 → 앱 비밀번호 관리
3. 새 앱 비밀번호 발급 (IMAP/SMTP 용)
4. 발급받은 비밀번호 저장 (재확인 불가)

### 3. OpenAI API 키 발급 (선택사항)

1. [https://platform.openai.com/api-keys](https://platform.openai.com/api-keys) 접속
2. Create new secret key 클릭
3. API 키 복사 및 보관

## 실행 방법

### 서비스 시작

```bash
python app.py
```

또는

```bash
python3 app.py
```

### 웹 브라우저 접속

서비스 시작 후 브라우저에서 다음 주소로 접속:

```
http://localhost:5000
```

또는 같은 네트워크의 다른 기기에서:

```
http://[서버IP]:5000
```

## 사용 방법

### 1. 로그인
1. **네이버 아이디** 입력 (예: example@naver.com)
2. **앱 비밀번호** 입력 (네이버 계정 비밀번호가 아님!)
4. **OpenAI API 키** 입력 (요약 기능 사용 시, 선택사항)
5. "연결하기" 버튼 클릭

### 2. 메일 조회
1. **메일박스 선택**:
   - 받은편지함: 받은 메일
   - 보낸편지함: 보낸 메일
   - 휴지통: 삭제된 메일
   - 스팸함: 스팸 메일
2. **필터 선택**:
   - 전체 메일: 모든 메일 조회
   - 안읽은 메일: 읽지 않은 메일만
   - 읽은 메일: 읽은 메일만
3. **조회 개수** 입력 (1~100)
4. "조회" 버튼 클릭
5. 왼쪽 패널에 메일 목록 표시

### 3. 메일 상세 보기
1. 메일 목록에서 원하는 메일 클릭
2. 가운데 패널에 상세 내용 표시:
   - 발신자, 수신자, 날짜
   - 본문 내용
   - 첨부파일 목록 (있는 경우)

### 4. 첨부파일 다운로드 및 요약
1. 메일 상세 화면에서 첨부파일 목록 확인
2. **다운로드**: 각 첨부파일 옆의 "다운로드" 버튼 클릭
   - 브라우저 다운로드 폴더에 파일 저장
3. **개별 첨부파일 요약**: "요약" 버튼 클릭
   - 현재 선택된 요약 타입과 LLM 모델 사용
   - 첨부파일 내용만 개별적으로 요약
   - 요약 결과가 오른쪽 요약 패널에 표시됨

### 5. 메일 요약
1. 메일 선택 후 오른쪽 요약 패널에서 옵션 선택:
   - **본문 체크박스**: 메일 본문 요약 여부
   - **첨부파일 체크박스**: 첨부파일 요약 여부
   - **요약 타입**: 간단/상세/목록/한국어 중 선택
   - **LLM 모델**: 사용할 GPT 모델 선택
2. "요약" 버튼 클릭
3. 요약 결과 및 통계 확인:
   - 본문 요약 (선택한 경우)
   - 첨부파일별 요약 (선택한 경우)
   - 통합 요약 (본문+첨부파일 모두 선택한 경우)
   - 토큰 통계 및 압축률

### 6. 메일 회신
1. 메일 선택 후 "회신" 버튼 클릭
2. 회신 모달 창에서:
   - **받는사람**: 자동으로 발신자 이메일 입력됨
   - **제목**: "Re:" 접두사가 자동으로 추가됨
   - **본문**: 원본 메일이 자동으로 인용됨
3. 회신 내용 작성
4. "전송" 버튼 클릭

### 7. 로그아웃
- 우측 상단의 "로그아웃" 버튼 클릭
- 연결이 종료되고 로그인 화면으로 이동

## User Flow (사용자 플로우)

### 전체 사용자 플로우 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                         시작 (웹 브라우저 접속)                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 로그인 플로우                                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ① 네이버 아이디 입력 (example@naver.com)                    │  │
│  │  ② 앱 비밀번호 입력                                          │  │
│  │  ③ OpenAI API 키 입력 (선택사항)                             │  │
│  │  ④ "연결하기" 버튼 클릭                                       │  │
│  │  ⑤ IMAP/SMTP 서버 연결 검증                                  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │   연결 성공?           │
                    └───────────┬───────────┘
                        YES     │      NO
                    ┌───────────┴───────────┐
                    ▼                       ▼
              메인 대시보드               에러 메시지 표시
                    │                    (로그인 화면 유지)
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 메일박스 선택 및 조회 플로우                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ① 메일박스 선택 (받은편지함/보낸편지함/휴지통/스팸함)           │  │
│  │  ② 필터 선택 (전체/안읽은/읽은)                               │  │
│  │  ③ 조회 개수 입력 (1~100)                                    │  │
│  │  ④ "조회" 버튼 클릭                                           │  │
│  │  ⑤ IMAP 서버에서 메일 목록 검색                               │  │
│  │  ⑥ 메일 메타데이터 다운로드                                   │  │
│  │  ⑦ 왼쪽 패널에 메일 목록 표시                                  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 메일 상세보기 플로우                                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ① 메일 목록에서 특정 메일 클릭                               │  │
│  │  ② 메일 상세 정보 요청 (API 호출)                             │  │
│  │  ③ 메일 본문 및 첨부파일 다운로드                             │  │
│  │  ④ 첨부파일 텍스트 추출 (PDF/Word/Excel/PPT)                 │  │
│  │  ⑤ downloads/email_XXX/ 폴더에 저장                          │  │
│  │  ⑥ 가운데 패널에 상세 내용 표시:                              │  │
│  │     - 발신자/수신자/날짜                                      │  │
│  │     - 본문 내용                                              │  │
│  │     - 첨부파일 목록 및 미리보기                                │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┬───────────────┐
                ▼               ▼               ▼               ▼
          첨부파일 다운로드    메일 요약      첨부파일 요약      메일 회신

┌─────────────────────────────────────────────────────────────────┐
│  4. 첨부파일 다운로드 플로우                                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ① 첨부파일 옆의 "다운로드" 버튼 클릭                          │  │
│  │  ② 서버에서 파일 전송 준비                                    │  │
│  │  ③ 브라우저 다운로드 시작                                     │  │
│  │  ④ 로컬 다운로드 폴더에 파일 저장                              │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  5. 메일 요약 플로우 (본문 + 첨부파일 통합)                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ① 오른쪽 요약 패널에서 옵션 선택:                             │  │
│  │     - 본문 요약 체크박스 (선택/해제)                           │  │
│  │     - 첨부파일 요약 체크박스 (선택/해제)                        │  │
│  │     - 요약 타입 (간단/상세/목록/한국어)                         │  │
│  │     - LLM 모델 (GPT-4o Mini/GPT-4o/GPT-4 Turbo 등)          │  │
│  │  ② "요약" 버튼 클릭                                           │  │
│  │  ③ 선택한 내용 텍스트 추출                                    │  │
│  │  ④ OpenAI API로 요약 요청                                    │  │
│  │  ⑤ 토큰 계산 (원본/요약)                                      │  │
│  │  ⑥ 필요시 청크 분할 처리                                      │  │
│  │  ⑦ 요약 결과 생성:                                           │  │
│  │     - 본문 요약 (선택한 경우)                                  │  │
│  │     - 첨부파일별 요약 (선택한 경우)                             │  │
│  │     - 통합 요약 (둘 다 선택한 경우)                             │  │
│  │  ⑧ 압축률 계산 및 통계 표시                                   │  │
│  │  ⑨ 오른쪽 패널에 결과 표시                                    │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  6. 개별 첨부파일 요약 플로우                                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ① 특정 첨부파일 옆의 "요약" 버튼 클릭                          │  │
│  │  ② 현재 선택된 요약 타입/모델 사용                             │  │
│  │  ③ 해당 첨부파일 텍스트만 추출                                 │  │
│  │  ④ OpenAI API로 요약 요청                                    │  │
│  │  ⑤ 요약 결과 및 통계 생성                                     │  │
│  │  ⑥ 오른쪽 요약 패널에 결과 표시                                │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  7. 메일 회신 플로우                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ① 메일 상세화면에서 "회신" 버튼 클릭                          │  │
│  │  ② 회신 모달 창 표시:                                         │  │
│  │     - 받는사람: 발신자 이메일 자동 입력                         │  │
│  │     - 제목: "Re:" 접두사 자동 추가                             │  │
│  │     - 본문: 원본 메일 자동 인용                                │  │
│  │  ③ 회신 내용 작성                                            │  │
│  │  ④ "전송" 버튼 클릭                                           │  │
│  │  ⑤ SMTP 서버로 메일 전송                                      │  │
│  │  ⑥ 전송 결과 확인 (성공/실패 메시지)                           │  │
│  │  ⑦ 모달 창 닫기                                              │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  8. 로그아웃 플로우                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ① 우측 상단 "로그아웃" 버튼 클릭                              │  │
│  │  ② IMAP/SMTP 연결 종료                                       │  │
│  │  ③ 세션 정리 (suite_instances에서 제거)                       │  │
│  │  ④ 로그인 화면으로 리다이렉트                                  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 주요 프로그램별 User Flow

#### app.py (Flask 웹 서버)

**사용자 상호작용:**
```
사용자 → 웹 브라우저 → Flask 서버 (app.py)
  │
  ├─ GET  /              → 메인 페이지 렌더링 (index.html)
  │
  ├─ POST /api/connect   → 로그인 및 메일 서버 연결
  │   ├─ NaverMailSuite 인스턴스 생성
  │   ├─ 세션 ID 발급
  │   └─ 연결 상태 반환
  │
  ├─ POST /api/select_mailbox → 메일박스 선택
  │   └─ IMAP 메일박스 변경
  │
  ├─ POST /api/fetch_emails → 메일 목록 조회
  │   ├─ 메일 검색 및 다운로드
  │   ├─ 첨부파일 자동 저장
  │   └─ 메일 목록 JSON 반환
  │
  ├─ POST /api/get_email_detail → 메일 상세 조회
  │   ├─ 본문 및 첨부파일 로드
  │   └─ 상세 정보 JSON 반환
  │
  ├─ POST /api/summarize_email → 메일 요약 (통합)
  │   ├─ 본문/첨부파일 선택적 요약
  │   ├─ OpenAI API 호출
  │   └─ 요약 결과 및 통계 반환
  │
  ├─ POST /api/summarize_attachment → 개별 첨부파일 요약
  │   ├─ 특정 첨부파일만 요약
  │   └─ 요약 결과 반환
  │
  ├─ POST /api/reply_email → 메일 회신 전송
  │   ├─ SMTP로 메일 발송
  │   └─ 전송 결과 반환
  │
  ├─ POST /api/download_attachment → 첨부파일 다운로드
  │   └─ 파일 스트리밍 전송
  │
  └─ POST /api/logout → 로그아웃
      ├─ 연결 종료
      └─ 세션 정리
```

**내부 처리 흐름:**
```
Flask 라우트 → 세션 검증 → NaverMailSuite 메서드 호출 → JSON 응답 반환
     │              │                    │                      │
     │              │                    └─ lib 모듈 활용        │
     │              └─ suite_instances 딕셔너리 조회            │
     └─ 요청 데이터 파싱                                        └─ 에러 핸들링
```

#### lib/naver_mail_parser.py (메일 수신/파싱)

**User Flow 관점:**
```
메일 조회 요청
    │
    ▼
① IMAP 서버 연결 (imap.naver.com:993, SSL)
    │
    ▼
② 메일박스 선택 (INBOX/Sent/Trash/Spam)
    │
    ▼
③ 검색 조건으로 메일 검색
    │  - ALL: 전체 메일
    │  - UNSEEN: 안읽은 메일
    │  - SEEN: 읽은 메일
    │
    ▼
④ 메일 목록 다운로드 (최대 N개)
    │
    ▼
⑤ 각 메일별 상세 정보 파싱:
    │  - 발신자/수신자/제목/날짜
    │  - 본문 (text/html)
    │  - 첨부파일 목록
    │
    ▼
⑥ 첨부파일 다운로드 및 저장
    │  - downloads/email_XXX/ 폴더 생성
    │  - 첨부파일 저장
    │  - metadata.json 생성
    │
    ▼
⑦ 첨부파일 텍스트 추출:
    │  - PDF → PyPDF2
    │  - Word → python-docx
    │  - Excel → openpyxl
    │  - PPT → python-pptx
    │  - 텍스트 파일 → 직접 읽기
    │
    ▼
⑧ 파싱 결과 반환 (딕셔너리 리스트)
```

**주요 메서드 플로우:**
```
connect() → select_mailbox() → fetch_emails() → close()
    │            │                    │
    │            │                    ├─ _parse_email()
    │            │                    ├─ _download_attachments()
    │            │                    └─ _extract_text_from_file()
    │            │
    │            └─ IMAP SELECT 명령
    │
    └─ IMAP LOGIN 명령
```

#### lib/naver_smtp_with_attachments.py (메일 발송)

**User Flow 관점:**
```
메일 회신/작성 요청
    │
    ▼
① SMTP 서버 연결 (smtp.naver.com:587, TLS)
    │
    ▼
② 로그인 인증
    │
    ▼
③ 메일 메시지 구성:
    │  - 헤더 (From/To/Cc/Bcc/Subject/Date)
    │  - 본문 (HTML/텍스트)
    │  - 첨부파일 (있는 경우)
    │
    ▼
④ MIME 멀티파트 메시지 생성
    │  - MIMEText: 본문
    │  - MIMEApplication: 첨부파일
    │
    ▼
⑤ SMTP 전송 (send_message)
    │
    ▼
⑥ 연결 종료
    │
    ▼
⑦ 전송 결과 반환 (성공/실패)
```

**주요 메서드 플로우:**
```
connect() → send_email() → close()
              │
              ├─ _create_message()
              ├─ _add_attachments()
              └─ SMTP send_message()
```

#### lib/text_summarizer.py (텍스트 요약)

**User Flow 관점:**
```
요약 요청 (본문/첨부파일)
    │
    ▼
① 텍스트 수집:
    │  - 본문 텍스트
    │  - 첨부파일 텍스트
    │
    ▼
② 토큰 계산 (tiktoken):
    │  - 원본 텍스트 토큰 수 계산
    │  - 모델별 토큰 제한 확인
    │
    ▼
③ 토큰 제한 초과 시 청크 분할:
    │  - 문장 단위 분할
    │  - 각 청크별 토큰 수 확인
    │
    ▼
④ 요약 프롬프트 생성:
    │  - 요약 타입별 프롬프트 (간단/상세/목록/한국어)
    │  - 사용자 지정 프롬프트 지원
    │
    ▼
⑤ OpenAI API 호출:
    │  - 선택한 모델 사용 (GPT-4o Mini/GPT-4o 등)
    │  - 각 청크별 요약 생성
    │
    ▼
⑥ 청크별 요약 통합:
    │  - 여러 청크 요약을 하나로 병합
    │
    ▼
⑦ 요약 통계 계산:
    │  - 원본 토큰 수
    │  - 요약 토큰 수
    │  - 압축률 (%)
    │
    ▼
⑧ 요약 결과 반환:
    │  - summary: 요약 텍스트
    │  - statistics: 통계 정보
```

**주요 메서드 플로우:**
```
summarize() → _count_tokens() → _split_into_chunks() → _summarize_chunk() → _merge_summaries()
    │              │                    │                      │                    │
    │              │                    │                      └─ OpenAI API       │
    │              │                    └─ 문장 단위 분할                           │
    │              └─ tiktoken 사용                                                │
    └─ 프롬프트 생성                                                              └─ 통합 요약
```

#### lib/naver_mail_suite.py (통합 인터페이스)

**User Flow 관점:**
```
사용자 요청 → NaverMailSuite (오케스트레이터)
    │
    ├─ 로그인 → 모든 컴포넌트 초기화
    │   ├─ NaverMailParser 생성 및 연결
    │   ├─ NaverSMTPSender 생성
    │   └─ TextSummarizer 생성 (OpenAI 키 있는 경우)
    │
    ├─ 메일 조회 → NaverMailParser 위임
    │   └─ fetch_emails() 호출
    │
    ├─ 메일 요약 → 복합 워크플로우
    │   ├─ NaverMailParser로 텍스트 추출
    │   └─ TextSummarizer로 요약 생성
    │
    ├─ 메일 회신 → NaverSMTPSender 위임
    │   └─ send_email() 호출
    │
    └─ 로그아웃 → 모든 연결 종료
        ├─ NaverMailParser.close()
        └─ NaverSMTPSender.close()
```

**통합 플로우:**
```
NaverMailSuite
    │
    ├─ mail_parser: NaverMailParser
    │   └─ IMAP 메일 수신/파싱
    │
    ├─ smtp_sender: NaverSMTPSender
    │   └─ SMTP 메일 발송
    │
    └─ summarizer: TextSummarizer
        └─ OpenAI 요약

워크플로우 조율:
    select_mailbox() → mail_parser.select_mailbox()
    fetch_emails() → mail_parser.fetch_emails()
    summarize_email_advanced() → mail_parser (텍스트) + summarizer (요약)
    send_email() → smtp_sender.send_email()
    get_status() → 모든 컴포넌트 상태 확인
```

### 세션 및 상태 관리 플로우

```
사용자 세션 생명주기:

① 로그인
    ├─ session_id 생성 (secrets.token_hex)
    ├─ NaverMailSuite 인스턴스 생성
    ├─ suite_instances[session_id] = suite
    └─ Flask session에 session_id 저장

② 사용 중
    ├─ 모든 API 요청마다:
    │   ├─ session['session_id'] 조회
    │   ├─ suite_instances[session_id] 조회
    │   └─ suite 메서드 호출
    │
    └─ 상태 유지 (24시간 세션)

③ 로그아웃
    ├─ suite.mail_parser.close()
    ├─ del suite_instances[session_id]
    └─ session.clear()
```

### 에러 처리 플로우

```
각 플로우에서 발생 가능한 에러:

① 로그인 플로우
    ├─ 인증 실패 → "메일 서버 연결 실패"
    ├─ 네트워크 오류 → "연결 시간 초과"
    └─ 잘못된 자격증명 → "아이디 또는 비밀번호 확인"

② 메일 조회 플로우
    ├─ 세션 만료 → "먼저 로그인해주세요"
    ├─ IMAP 오류 → "메일 조회 실패"
    └─ 파싱 오류 → "메일 파싱 중 오류 발생"

③ 요약 플로우
    ├─ OpenAI 키 없음 → "API 키가 설정되지 않았습니다"
    ├─ API 오류 → "요약 생성 실패"
    ├─ 토큰 초과 → 자동 청크 분할 처리
    └─ 텍스트 없음 → "요약할 내용이 없습니다"

④ 회신 플로우
    ├─ SMTP 연결 실패 → "메일 전송 실패"
    ├─ 인증 오류 → "SMTP 인증 실패"
    └─ 수신자 오류 → "올바른 이메일 주소를 입력하세요"

⑤ 첨부파일 플로우
    ├─ 파일 없음 → "파일을 찾을 수 없습니다"
    ├─ 지원하지 않는 형식 → "지원하지 않는 파일 형식"
    └─ 텍스트 추출 실패 → "텍스트 추출 실패"
```

## 프로젝트 구조

```
mail_service/
├── app.py                         # Flask 웹 서버
├── lib/                           # 핵심 라이브러리
│   ├── __init__.py               # 패키지 초기화
│   ├── naver_mail_parser.py      # IMAP 메일 파싱 및 첨부파일 처리
│   ├── naver_smtp_sender.py      # SMTP 메일 발송
│   ├── text_summarizer.py        # OpenAI 요약 (첨부파일 파싱 포함)
│   └── naver_mail_suite.py       # 통합 인터페이스
├── templates/
│   └── index.html                # 메인 웹 페이지
├── static/
│   ├── style.css                 # 스타일시트
│   └── app.js                    # 프론트엔드 로직
├── downloads/                    # 첨부파일 다운로드 폴더 (자동 생성)
├── requirements.txt              # 의존성 패키지
└── README.md                     # 이 파일
```

## 시스템 아키텍처

### 전체 구조도

```
┌─────────────────────────────────────────────────────────────┐
│                        사용자 (웹 브라우저)                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      프론트엔드 (Web UI)                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  - HTML/CSS/JavaScript (Vanilla JS)                  │   │
│  │  - static/app.js: AJAX 통신, UI 이벤트 처리           │   │
│  │  - templates/index.html: 메인 페이지 템플릿           │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ (HTTP/AJAX)
┌─────────────────────────────────────────────────────────────┐
│                    백엔드 (Flask Web Server)                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  app.py - Flask 애플리케이션                          │   │
│  │  - 라우팅 및 API 엔드포인트 제공                       │   │
│  │  - 세션 관리 (suite_instances)                        │   │
│  │  - 요청/응답 처리                                      │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    통합 레이어 (Suite)                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  lib/naver_mail_suite.py - NaverMailSuite           │   │
│  │  - 모든 핵심 기능 통합 관리                            │   │
│  │  - 컴포넌트 초기화 및 상태 관리                         │   │
│  │  - 워크플로우 조율                                     │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                    │           │           │
          ┌─────────┘           │           └─────────┐
          ▼                     ▼                     ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│   메일 수신/파싱    │  │   텍스트 요약      │  │   메일 발송       │
│                  │  │                  │  │                  │
│ naver_mail_      │  │ text_           │  │ naver_smtp_      │
│ parser.py        │  │ summarizer.py    │  │ with_           │
│                  │  │                  │  │ attachments.py   │
│ - IMAP 연결      │  │ - OpenAI API    │  │ - SMTP 연결      │
│ - 메일 검색       │  │ - 토큰 계산      │  │ - 메일 전송       │
│ - 본문 파싱       │  │ - 청크 분할      │  │ - 첨부파일 처리    │
│ - 첨부파일 다운로드 │  │ - 요약 생성      │  │                  │
│ - 텍스트 추출     │  │                  │  │                  │
└──────────────────┘  └──────────────────┘  └──────────────────┘
          │                     │                     │
          ▼                     ▼                     ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  네이버 IMAP      │  │  OpenAI API      │  │  네이버 SMTP      │
│  (imap.naver.com)│  │                  │  │  (smtp.naver.com)│
└──────────────────┘  └──────────────────┘  └──────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│                    로컬 저장소 (downloads/)                     │
│  - 메일별 폴더 (email_XXX/)                                    │
│  - 첨부파일 저장                                               │
│  - 메타데이터 (metadata.json)                                 │
│  - 본문 (body.txt, body.html)                                │
└─────────────────────────────────────────────────────────────┘
```

### 핵심 컴포넌트

#### 1. **프론트엔드 (Web UI)**
- **기술**: HTML5, CSS3, Vanilla JavaScript
- **역할**:
  - 사용자 인터페이스 제공
  - AJAX를 통한 백엔드 API 호출
  - 실시간 UI 업데이트
  - 사용자 입력 검증
- **주요 파일**:
  - `templates/index.html`: 메인 페이지 템플릿
  - `static/style.css`: UI 스타일링
  - `static/app.js`: 프론트엔드 로직

#### 2. **백엔드 (Flask Server)**
- **기술**: Flask 3.0+, Python 3.8+
- **역할**:
  - RESTful API 엔드포인트 제공
  - 세션 관리 (suite_instances 딕셔너리)
  - 요청 라우팅 및 응답 처리
  - 인증 및 권한 관리
- **주요 파일**:
  - `app.py`: Flask 애플리케이션 메인
- **주요 엔드포인트**:
  - `/api/connect`: 메일 서버 연결
  - `/api/fetch_emails`: 메일 목록 조회
  - `/api/get_email_detail`: 메일 상세 조회
  - `/api/summarize_email`: 메일 요약
  - `/api/reply_email`: 메일 회신
  - `/api/download_attachment`: 첨부파일 다운로드

#### 3. **통합 레이어 (Suite)**
- **기술**: Python OOP
- **역할**:
  - 모든 핵심 기능 통합 관리
  - 컴포넌트 초기화 및 의존성 주입
  - 워크플로우 조율 및 오케스트레이션
  - 상태 관리 및 모니터링
- **주요 파일**:
  - `lib/naver_mail_suite.py`: NaverMailSuite 클래스
- **주요 클래스**:
  - `NaverMailSuite`: 메인 통합 클래스
  - `MailProcessor`: 메일 처리 워크플로우
  - `BatchProcessor`: 대량 메일 처리

#### 4. **메일 수신/파싱 모듈**
- **기술**: imaplib, email, BeautifulSoup4
- **역할**:
  - IMAP 프로토콜을 통한 메일 수신
  - 메일 본문 파싱 (text/html)
  - 첨부파일 다운로드 및 저장
  - 다양한 형식의 첨부파일 텍스트 추출
- **주요 파일**:
  - `lib/naver_mail_parser.py`: NaverMailParser 클래스
- **지원 첨부파일**:
  - PDF (PyPDF2)
  - Word (python-docx)
  - Excel (openpyxl)
  - PowerPoint (python-pptx)
  - 텍스트 파일 (txt, csv, json, xml, html 등)

#### 5. **텍스트 요약 모듈**
- **기술**: OpenAI API, tiktoken
- **역할**:
  - LLM을 활용한 텍스트 요약
  - 토큰 계산 및 최적화
  - 긴 텍스트 청크 분할 처리
  - 다양한 요약 스타일 제공
- **주요 파일**:
  - `lib/text_summarizer.py`: TextSummarizer 클래스
- **지원 모델**:
  - GPT-4o Mini (기본)
  - GPT-4o
  - GPT-4 Turbo
  - GPT-4
  - GPT-3.5 Turbo
- **요약 타입**:
  - brief: 간단 요약
  - detailed: 상세 요약
  - bullet: 불릿 포인트
  - korean: 한국어 최적화

#### 6. **메일 발송 모듈**
- **기술**: smtplib, email.mime
- **역할**:
  - SMTP 프로토콜을 통한 메일 발송
  - 다양한 MIME 타입 첨부파일 처리
  - 참조/숨은참조 지원
  - HTML/텍스트 본문 지원
- **주요 파일**:
  - `lib/naver_smtp_with_attachments.py`: NaverSMTPSender 클래스
- **주요 기능**:
  - TLS/SSL 암호화 지원
  - 자동 MIME 타입 감지
  - 다중 수신자 처리

### 데이터 플로우

#### 메일 조회 플로우
1. 사용자가 웹 UI에서 메일 조회 요청
2. JavaScript가 `/api/fetch_emails` 엔드포인트로 AJAX 요청
3. Flask 서버가 세션에서 NaverMailSuite 인스턴스 조회
4. NaverMailSuite가 NaverMailParser 호출
5. NaverMailParser가 IMAP 서버에서 메일 검색 및 다운로드
6. 첨부파일 다운로드 및 텍스트 추출
7. 메일 데이터를 `downloads/email_XXX/` 폴더에 저장
8. 파싱된 데이터를 JSON으로 반환
9. 웹 UI에 메일 목록 표시

#### 메일 요약 플로우
1. 사용자가 요약 옵션 선택 (본문/첨부파일, 타입, 모델)
2. JavaScript가 `/api/summarize_email` 엔드포인트로 AJAX 요청
3. Flask 서버가 NaverMailSuite.summarize_email_advanced() 호출
4. NaverMailSuite가 TextSummarizer에 요약 요청
5. TextSummarizer가 OpenAI API 호출
6. 토큰 계산 및 필요시 청크 분할
7. 요약 결과 생성 (본문/첨부파일/통합)
8. 요약 통계 계산 (토큰, 압축률)
9. JSON 결과 반환
10. 웹 UI에 요약 결과 표시

#### 메일 회신 플로우
1. 사용자가 회신 버튼 클릭
2. 모달 창에 원본 메일 정보 자동 입력
3. 사용자가 회신 내용 작성
4. JavaScript가 `/api/reply_email` 엔드포인트로 AJAX 요청
5. Flask 서버가 NaverMailSuite.send_email() 호출
6. NaverMailSuite가 NaverSMTPSender 호출
7. NaverSMTPSender가 SMTP 서버로 메일 전송
8. 전송 결과 반환
9. 웹 UI에 결과 표시

### 세션 관리

```python
# app.py에서 세션 관리
suite_instances = {}  # 세션 ID -> NaverMailSuite 인스턴스 매핑

# 로그인 시
session_id = secrets.token_hex(16)
suite = NaverMailSuite(username, password, openai_key)
suite_instances[session_id] = suite
session['session_id'] = session_id

# API 요청 시
session_id = session.get('session_id')
suite = suite_instances[session_id]
# suite 사용하여 작업 수행

# 로그아웃 시
suite.mail_parser.close()
del suite_instances[session_id]
session.clear()
```

### 파일 저장 구조

```
downloads/
├── email_123/
│   ├── metadata.json       # 메일 메타데이터
│   ├── body.txt           # 텍스트 본문
│   ├── body.html          # HTML 본문
│   ├── attachment1.pdf    # 첨부파일 1
│   └── attachment2.docx   # 첨부파일 2
├── email_124/
│   └── ...
└── email_125/
    └── ...
```

### 보안 아키텍처

1. **인증**:
   - 네이버 앱 비밀번호 사용 (계정 비밀번호 X)
   - 세션 기반 인증 (Flask session)
   - 세션 ID는 secrets.token_hex()로 생성

2. **통신 암호화**:
   - IMAP: SSL/TLS (포트 993)
   - SMTP: STARTTLS (포트 587)
   - OpenAI API: HTTPS

3. **데이터 보호**:
   - API 키는 환경 변수 또는 세션에만 저장
   - 다운로드 파일은 로컬 저장소에만 보관
   - 세션 타임아웃 24시간

### 확장성 고려사항

1. **수평 확장**:
   - 세션 저장소를 Redis로 전환 가능
   - 다중 Flask 워커 지원 (Gunicorn)

2. **기능 확장**:
   - 플러그인 아키텍처로 새로운 요약 엔진 추가 가능
   - 다른 메일 서비스 지원 (Gmail, Outlook 등)

3. **성능 최적화**:
   - 비동기 처리 (Celery + Redis)
   - 캐싱 레이어 추가
   - 데이터베이스 도입 (메일 메타데이터 저장)

## API 엔드포인트

| 엔드포인트 | 메서드 | 설명 |
|-----------|--------|------|
| `/` | GET | 메인 페이지 |
| `/api/connect` | POST | 메일 서버 연결 |
| `/api/select_mailbox` | POST | 메일박스 선택 |
| `/api/fetch_emails` | POST | 메일 목록 조회 |
| `/api/get_email_detail` | POST | 메일 상세 조회 |
| `/api/summarize_email` | POST | 메일 요약 (본문+첨부파일) |
| `/api/summarize_attachment` | POST | 개별 첨부파일 요약 |
| `/api/reply_email` | POST | 메일 회신 전송 |
| `/api/download_attachment` | POST | 첨부파일 다운로드 |
| `/api/logout` | POST | 로그아웃 |

## 기술 스택

### 백엔드
- **Python 3.8+**
- **Flask 3.0+**: 웹 프레임워크
- **OpenAI API 1.0+**: LLM 요약
- **imaplib**: IMAP 프로토콜 (메일 수신)
- **smtplib**: SMTP 프로토콜 (메일 발송)

### 프론트엔드
- **HTML5**
- **CSS3** (Custom Variables)
- **Vanilla JavaScript** (ES6+)
- **Fetch API**: 비동기 통신

### 라이브러리
- **python-docx**: Word 파일 처리
- **openpyxl**: Excel 파일 처리
- **PyPDF2**: PDF 파일 처리
- **python-pptx**: PowerPoint 파일 처리
- **BeautifulSoup4**: HTML 파싱
- **tiktoken**: 토큰 계산

## 보안 주의사항

### 1. 앱 비밀번호 관리
- 앱 비밀번호는 네이버 계정 비밀번호가 **아닙니다**
- 외부에 노출되지 않도록 주의하세요
- 정기적으로 비밀번호를 변경하세요

### 2. OpenAI API 키 관리
- API 키는 절대 공개 저장소에 커밋하지 마세요
- 사용량 제한 및 모니터링을 설정하세요
- `.env` 파일 사용을 권장합니다

### 3. HTTPS 사용 권장
- 프로덕션 환경에서는 반드시 HTTPS를 사용하세요
- 리버스 프록시 (nginx, Apache) 설정 권장
- Let's Encrypt로 무료 SSL 인증서 발급 가능

### 4. 방화벽 설정
- 필요한 포트만 개방:
  - 993 (IMAP SSL)
  - 587 (SMTP TLS)
  - 5000 (Flask 개발 서버, 프로덕션은 변경 권장)

## 문제 해결

### 메일 서버 연결 실패
**증상**: "메일 서버 연결 실패" 오류 메시지

**해결 방법**:
1. 네이버 앱 비밀번호가 올바른지 확인
2. 네이버 계정의 IMAP/SMTP 설정 활성화 확인
3. 방화벽에서 포트 993(IMAP), 587(SMTP) 허용 확인
4. 인터넷 연결 상태 확인

### 요약 기능 오류
**증상**: "OpenAI API 키가 설정되지 않았습니다" 또는 요약 실패

**해결 방법**:
1. OpenAI API 키가 유효한지 확인
2. API 사용량 한도 확인 (https://platform.openai.com/usage)
3. 인터넷 연결 상태 확인
4. OpenAI API 서비스 상태 확인

### 회신 전송 실패
**증상**: "회신 전송 실패" 오류 메시지

**해결 방법**:
1. SMTP 서버 연결 상태 확인
2. 받는사람 이메일 주소 형식 확인
3. 네이버 앱 비밀번호 재확인
4. 네이버 SMTP 일일 발송 제한 확인

### 첨부파일 다운로드 실패
**증상**: 다운로드 버튼 클릭 시 오류

**해결 방법**:
1. 메일을 먼저 조회했는지 확인 (첨부파일 다운로드 필요)
2. `downloads/` 폴더 권한 확인
3. 디스크 공간 확인
4. 브라우저 다운로드 설정 확인

### 첨부파일 텍스트 추출 실패
**증상**: 첨부파일 요약 시 "텍스트를 추출할 수 없는 파일입니다"

**해결 방법**:
1. 파일 형식이 지원되는지 확인 (PDF, Word, Excel, PPT, 텍스트)
2. 파일이 암호화되지 않았는지 확인
3. 파일이 손상되지 않았는지 확인
4. 필요한 라이브러리가 설치되어 있는지 확인:
   ```bash
   pip install PyPDF2 python-docx openpyxl python-pptx
   ```

## 성능 최적화

### 메일 조회 최적화
- 한 번에 너무 많은 메일을 조회하지 마세요 (권장: 10~20개)
- `download_full=True` 옵션은 필요할 때만 사용

### 요약 최적화
- 긴 메일은 요약 시간이 오래 걸릴 수 있습니다
- GPT-4o Mini 모델이 가장 빠르고 경제적입니다
- 첨부파일 요약은 선택적으로 사용

### 네트워크 최적화
- 안정적인 네트워크 환경에서 사용
- VPN 사용 시 성능 저하 가능

## 개발 환경 설정

### 개발 모드 실행
```bash
export FLASK_ENV=development
python app.py
```

### 디버그 모드
`app.py` 파일에서 `debug=True` 설정

### 환경 변수 사용
```bash
# .env 파일 생성
NAVER_USERNAME=your_id@naver.com
NAVER_PASSWORD=your_app_password
OPENAI_API_KEY=your_openai_key

# 환경 변수 로드
python-dotenv 설치 후 app.py에서 로드
```

## 프로덕션 배포

### WSGI 서버 사용 (Gunicorn)
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### Nginx 리버스 프록시 설정
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### systemd 서비스 등록
```ini
[Unit]
Description=Naver Mail Suite
After=network.target

[Service]
User=your-user
WorkingDirectory=/path/to/claude-test
ExecStart=/path/to/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 app:app
Restart=always

[Install]
WantedBy=multi-user.target
```
